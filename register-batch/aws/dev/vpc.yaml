AWSTemplateFormatVersion: '2010-09-09'
Description: VPC for NMA Register Batch (dev)

Parameters:
  ExistingVpcId:
    Type: AWS::EC2::VPC::Id
    Description: "既存 VPC の ID"
  ExistingInternetGatewayId:
    Type: String
    Description: "既存 Internet Gateway の ID"
    AllowedPattern: '^igw-[0-9a-fA-F]+$'

Resources:
  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref ExistingVpcId
      Tags:
        - Key: Name
          Value: dev-niconico-mylist-assistant-register-batch-public-rt

  PublicRoute:
    Type: AWS::EC2::Route
    DependsOn: PublicRouteTable
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref ExistingInternetGatewayId

  PublicSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref ExistingVpcId
      CidrBlock: 10.0.0.0/24
      AvailabilityZone: !Select [ 0, !GetAZs '' ]
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: dev-niconico-mylist-assistant-register-batch-public-subnet-1

  PublicSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref ExistingVpcId
      CidrBlock: 10.0.1.0/24
      AvailabilityZone: !Select [ 1, !GetAZs '' ]
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: dev-niconico-mylist-assistant-register-batch-public-subnet-2

  SubnetRouteTableAssociation1:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet1
      RouteTableId: !Ref PublicRouteTable

  SubnetRouteTableAssociation2:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet2
      RouteTableId: !Ref PublicRouteTable

  Ec2SecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for NMA Register Batch ECS tasks (dev)
      VpcId: !Ref ExistingVpcId
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: dev-niconico-mylist-assistant-register-batch-ecs-sg

  EndpointSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for VPC interface endpoints (allow tasks to call ECR)
      VpcId: !Ref ExistingVpcId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          SourceSecurityGroupId: !Ref Ec2SecurityGroup
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: dev-niconico-mylist-assistant-register-batch-endpoint-sg

  S3GatewayEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref ExistingVpcId
      ServiceName: !Sub com.amazonaws.${AWS::Region}.s3
      RouteTableIds:
        - !Ref PublicRouteTable
      VpcEndpointType: Gateway
      Tags:
        - Key: Name
          Value: dev-niconico-mylist-assistant-register-batch-s3-endpoint

  EcrApiEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref ExistingVpcId
      ServiceName: !Sub com.amazonaws.${AWS::Region}.ecr.api
      VpcEndpointType: Interface
      SubnetIds:
        - !Ref PublicSubnet1
        - !Ref PublicSubnet2
      SecurityGroupIds:
        - !Ref EndpointSecurityGroup
      PrivateDnsEnabled: true
      Tags:
        - Key: Name
          Value: dev-niconico-mylist-assistant-register-batch-ecr-api-endpoint

  EcrDkrEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref ExistingVpcId
      ServiceName: !Sub com.amazonaws.${AWS::Region}.ecr.dkr
      VpcEndpointType: Interface
      SubnetIds:
        - !Ref PublicSubnet1
        - !Ref PublicSubnet2
      SecurityGroupIds:
        - !Ref EndpointSecurityGroup
      PrivateDnsEnabled: true
      Tags:
        - Key: Name
          Value: dev-niconico-mylist-assistant-register-batch-ecr-dkr-endpoint

  CloudWatchLogsEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcEndpointType: Interface
      VpcId: !Ref ExistingVpcId
      ServiceName: !Sub com.amazonaws.${AWS::Region}.logs
      SubnetIds:
        - !Ref PublicSubnet1
        - !Ref PublicSubnet2
      SecurityGroupIds:
        - !Ref EndpointSecurityGroup
      PrivateDnsEnabled: true
      Tags:
        - Key: Name
          Value: dev-niconico-mylist-assistant-register-batch-cloudwatch-logs-endpoint

Outputs:
  PublicSubnet1Id:
    Description: Public subnet 1 id
    Value: !Ref PublicSubnet1

  PublicSubnet2Id:
    Description: Public subnet 2 id
    Value: !Ref PublicSubnet2

  SecurityGroupId:
    Description: Security Group Id for ECS tasks
    Value: !Ref Ec2SecurityGroup

# To deploy this template, run:
# aws cloudformation deploy \
#   --template-file register-batch/aws/dev/vpc.yaml \
#   --stack-name dev-niconico-mylist-assistant-register-batch-vpc \
#   --parameter-overrides ExistingVpcId= ExistingInternetGatewayId=
